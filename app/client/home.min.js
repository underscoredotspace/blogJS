angular.module("colonApp",["ngRoute","ngCookies","ng-showdown"]),function(){function o(o,n){t(o),e(n)}function t(o){o.when("/about",{templateUrl:"part/about.html"}).when("/home",{templateUrl:"part/posts.html",controller:"home"}).when("/home/:page",{templateUrl:"part/posts.html",controller:"home"}).when("/post/:id",{templateUrl:"part/posts.html",controller:"post"}).when("/new",{templateUrl:"part/newpost.html",controller:"new"}).when("/edit/:id",{templateUrl:"part/newpost.html",controller:"edit"}).when("/login",{templateUrl:"part/login.html",controller:"login"}).when("/logout",{template:'<div class="part">Logging out...</div>',controller:"logout"}).when("/setup/",{templateUrl:"part/setup.html",controller:"setup"}).otherwise({redirectTo:"/home"})}function e(o){window.showdown.extension("codehighlight",function(){const o=o=>o.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">");return[{type:"output",filter:function(t,e,n){var l=(t,e,n,l)=>{e=o(e);return n+window.hljs.highlightAuto(e).value+l};return window.showdown.helper.replaceRecursiveRegExp(t,l,"<code\\b[^>]*>","</code>","g")}}]}),o.loadExtension("codehighlight")}angular.module("colonApp").config(o),o.$inject=["$routeProvider","$showdownProvider"]}(),function(){function o(o){o.debugInfoEnabled(!1),o.commentDirectivesEnabled(!1)}angular.module("colonApp").config(o),o.$inject=["$compileProvider"]}(),function(){function o(o){const t=this;t.loggedin=!1,o.get("qqBlog")&&(t.loggedin=!0)}angular.module("colonApp").controller("blogController",o),o.$inject=["$cookies"]}(),function(){angular.module("colonApp").directive("blogPost",function(){function o(o,t,e){const n=this;n.postDelete=function(l){o({method:"delete",url:"/api/post/"+l,headers:{"Content-Type":"application/json"}}).then(function(o){console.log("deleted",l),n.$parent.blogposts=t("filter")(n.$parent.blogposts,{_id:"!"+l}),e.path()==="/post/"+l&&e.path("/")}).catch(function(o,t){console.log(o),console.log(t)})},n.postEdit=function(o){console.log("edit",o),e.path("/edit/"+o)}}const t={restrict:"C",controller:o,controllerAs:"vm"};return o.$inject=["$http","$filter","$location"],t})}(),function(){function o(o,t,e){o.$parent.blog.loggedin?t.get("/api/logout").then(function(t){o.$parent.blog.loggedin=!1,e.path("/home")},function(t){console.error(t),o.$parent.blog.loggedin=!1,e.path("/home")}):e.path("/home")}angular.module("colonApp").controller("logout",o),o.$inject=["$scope","$http","$location"]}(),function(){function o(o,t){t.get(null,function(t,e){t?console.error(t):o.blogposts=e})}angular.module("colonApp").controller("home",o),o.$inject=["$scope","blogService"]}(),function(){function o(o,t,e,n,l){function i(t,l){o.$parent.error=t,l&&n(function(){o.$parent.error=null,e.path("/home")},3e3)}/[0-9a-fA-F]{24}/i.test(t.id)?l.get(t.id,function(t,e){t?i("Error getting post"):204===e.status?i("Invalid post. Going home...",!0):o.blogposts=e}):i("Invalid post. Going home...",!0)}angular.module("colonApp").controller("post",o),o.$inject=["$scope","$routeParams","$location","$timeout","blogService"]}(),function(){function o(o,t,e){o.$parent.blog.loggedin?(o.blogpost={title:"",content:"",date:new Date},o.submitPost=function(){var n={title:o.blogpost.title,content:o.blogpost.content};t({url:"/api/new",method:"POST",data:{blogpost:n},headers:{"Content-Type":"application/json"}}).then(function(o){o.data.hasOwnProperty("ID")&&e.path("/post/"+o.data.ID)},function(o){console.error(o.data)})}):e.path("/login")}angular.module("colonApp").controller("new",o),o.$inject=["$scope","$http","$location"]}(),function(){function o(o,t,e,n,l){t.get(e.id,function(t,e){t?console.error(t):204===e.status?(console.info("Post doesn't exist"),n.path("/home")):o.blogpost=e[0]}),o.submitPost=function(){var t={title:o.blogpost.title,content:o.blogpost.content};l({url:"/api/post/"+e.id,method:"PATCH",data:{blogpost:t},headers:{"Content-Type":"application/json"}}).then(function(o){n.path("/post/"+e.id)},function(o){console.error(o.data)})}}angular.module("colonApp").controller("edit",o),o.$inject=["$scope","blogService","$routeParams","$location","$http"]}(),function(){function o(o,t,e){o.$parent.blog.loggedin?e.path("/home"):o.login=function(){t({url:"/api/login",method:"POST",data:{code:o.gaCode},headers:{"Content-Type":"application/json"}}).then(function(t){o.$parent.blog.loggedin=!0,e.path("/home")},function(o){console.error(o.data)})}}angular.module("colonApp").controller("login",o),o.$inject=["$scope","$http","$location"]}(),function(){function o(o,t,e){t({url:"/api/setup/adminCode",method:"GET"}).then(function(t){o.message="Check the server console to get your setup code"},function(t){console.error(t.data),o.message="Error getting setup code."}),o.step=1,o.getQR=function(){t({url:"/api/setup/QR",method:"POST",data:{code:o.setupCode},headers:{"Content-Type":"application/json"}}).then(function(t){t.data.hasOwnProperty("qr")&&(o.qr=e.trustAsHtml(t.data.qr),o.message="Scan the QR code with Google Authenticator and input the code to verify",o.adminCode=null,o.step=2)},function(t){t.data.verified?(o.message=`You're already verified. \n                          If you lost the code in Google Authenticator, \n                          delete the admin collection in the database to start again`,o.step=0):o.message=`Error getting QR code. \n                            Restart blog on the server and \n                            come back to this page to generate a new setup code`,console.error(t.data)})},o.verify=function(){t({url:"/api/setup/verify",method:"POST",data:{code:o.gaCode},headers:{"Content-Type":"application/json"}}).then(function(t){o.$parent.blog.loggedin=!0,o.qr=null,o.message=null,o.gaCode=null,o.step=3},function(t){o.message=`Error verifying code. \n                          Try again with the next one. \n                          If this still doesn't work, delete the admin collection in the database and start again`,console.error(t.data)})}}angular.module("colonApp").controller("setup",o),o.$inject=["$scope","$http","$sce"]}(),function(){angular.module("colonApp").filter("niceDate",function(){return function(o){var t={year:"numeric",month:"long",day:"numeric"};return new Date(o).toLocaleDateString("en-GB",t)}})}(),function(){function o(o){return t=>o.trustAsHtml(t)}angular.module("colonApp").filter("trustHTML",o),o.$inject=["$sce"]}(),function(){function o(o,t,e){function n(o,t){o.forEach(function(o,t){o.contentHTML=e.makeHtml(o.content)}),t(o)}return{get:function(t,e){let l;l=t?"post/"+t:"latest/5",o.get("/api/"+l).then(function(o){if(204===o.status){console.warn("no posts yet!");const o=[{title:"Welcome",content:'This is your blog. Make a <a href="/#!/new">post</a>. ',date:new Date}];e(null,o)}else n(o.data,function(o){e(null,o)})}).catch(function(o){e(o)})},delete:function(t){return o({method:"delete",url:"/api/post/"+t,headers:{"Content-Type":"application/json"}})},edit:function(e,n){return angular.isDefined(n)?o({method:"PATCH",url:"/api/post/"+e,data:{blogpost:n},headers:{"Content-Type":"application/json"}}):t.reject("Edited post required")},new:function(){}}}angular.module("colonApp").service("blogService",o),o.$inject=["$http","$q","$showdown"]}();