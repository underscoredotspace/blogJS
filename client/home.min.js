angular.module("colonApp",["ngRoute","ngCookies","ng-showdown"]).config(["$showdownProvider","$routeProvider","$compileProvider",function(a,b,c){c.debugInfoEnabled(!1),c.commentDirectivesEnabled(!1),window.showdown.extension("codehighlight",function(){function a(a){return a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}return[{type:"output",filter:function(b,c,d){var e=function(b,c,d,e){return c=a(c),d+window.hljs.highlightAuto(c).value+e};return window.showdown.helper.replaceRecursiveRegExp(b,e,"<code\\b[^>]*>","</code>","g")}}]}),a.loadExtension("codehighlight"),b.when("/about",{templateUrl:"part/about.html",controller:function(){}}).when("/home",{templateUrl:"part/posts.html",controller:"home"}).when("/home/:page",{templateUrl:"part/posts.html",controller:"home"}).when("/post/:id",{templateUrl:"part/posts.html",controller:"post"}).when("/new",{templateUrl:"part/newpost.html",controller:"new"}).when("/edit/:id",{templateUrl:"part/newpost.html",controller:"edit"}).when("/login",{templateUrl:"part/login.html",controller:"login"}).when("/logout",{template:'<div class="part">Logging out...</div>',controller:"logout"}).when("/setup/",{templateUrl:"part/setup.html",controller:"setup"}).otherwise({redirectTo:"/home"})}]).controller("blog",["$scope","$cookies","$http","$filter",function(a,b,c,d){b.get("qqBlog")?a.loggedin=!0:a.loggedin=!1}]).directive("blogPost",function(){return{restrict:"C",controller:["$scope","$http","$filter","$location",function(a,b,c,d){a.postDelete=function(e){b({method:"delete",url:"/api/post/"+e,headers:{"Content-Type":"application/json"}}).then(function(b){console.log("deleted",e),a.$parent.blogposts=c("filter")(a.$parent.blogposts,{_id:"!"+e}),d.path()==="/post/"+e&&d.path("/")}).catch(function(a,b){console.log(a),console.log(b)})},a.postEdit=function(a){console.log("edit",a),d.path("/edit/"+a)}}]}}).controller("logout",["$scope","$http","$location",function(a,b,c){a.$parent.loggedin?b.get("/api/logout").then(function(b){a.$parent.loggedin=!1,c.path("/home")},function(b){console.error(b),a.$parent.loggedin=!1,c.path("/home")}):c.path("/home")}]).controller("home",["$scope","blogService",function(a,b){b.get(null,function(b,c){b?console.error(b):a.blogposts=c})}]).controller("post",["$scope","$routeParams","$location","$timeout","blogService",function(a,b,c,d,e){function f(b,e){a.$parent.error=b,e&&d(function(){a.$parent.error=null,c.path("/home")},3e3)}/[0-9a-fA-F]{24}/i.test(b.id)?e.get(b.id,function(b,c){b?f("Error getting post"):204===c.status?f("Invalid post. Going home...",!0):a.blogposts=c}):f("Invalid post. Going home...",!0)}]).controller("new",["$scope","$http","$location",function(a,b,c){a.$parent.loggedin?(a.blogpost={title:"",content:"",date:new Date},a.submitPost=function(){var d={title:a.blogpost.title,content:a.blogpost.content};b({url:"/api/new",method:"POST",data:{blogpost:d},headers:{"Content-Type":"application/json"}}).then(function(a){a.data.hasOwnProperty("ID")&&c.path("/post/"+a.data.ID)},function(a){console.error(a.data)})}):c.path("/login")}]).controller("edit",["$scope","blogService","$routeParams","$location","$http",function(a,b,c,d,e){b.get(c.id,function(b,c){b?console.error(b):204===c.status?(console.info("Post doesn't exist"),d.path("/home")):a.blogpost=c[0]}),a.submitPost=function(){var b={title:a.blogpost.title,content:a.blogpost.content};e({url:"/api/post/"+c.id,method:"PATCH",data:{blogpost:b},headers:{"Content-Type":"application/json"}}).then(function(a){d.path("/post/"+c.id)},function(a){console.error(a.data)})}}]).controller("login",["$scope","$http","$location",function(a,b,c){a.$parent.loggedin?c.path("/home"):a.login=function(){b({url:"/api/login",method:"POST",data:{code:a.gaCode},headers:{"Content-Type":"application/json"}}).then(function(b){a.$parent.loggedin=!0,c.path("/home")},function(a){console.error(a.data)})}}]).controller("setup",["$scope","$http","$sce",function(a,b,c){b({url:"/api/setup/adminCode",method:"GET"}).then(function(b){a.message="Check the server console to get your setup code"},function(b){console.error(b.data),a.message="Error getting setup code."}),a.step=1,a.getQR=function(){b({url:"/api/setup/QR",method:"POST",data:{code:a.setupCode},headers:{"Content-Type":"application/json"}}).then(function(b){b.data.hasOwnProperty("qr")&&(a.qr=c.trustAsHtml(b.data.qr),a.message="Scan the QR code with Google Authenticator and input the code to verify",a.adminCode=null,a.step=2)},function(b){b.data.verified?(a.message="You're already verified. If you lost the code in Google Authenticator, delete the admin collection in the database to start again",a.step=0):a.message="Error getting QR code. Restart blog on the server and come back to this page to generate a new setup code",console.error(b.data)})},a.verify=function(){b({url:"/api/setup/verify",method:"POST",data:{code:a.gaCode},headers:{"Content-Type":"application/json"}}).then(function(b){a.$parent.loggedin=!0,a.qr=null,a.message=null,a.gaCode=null,a.step=3},function(b){a.message="Error verifying code. Try again with the next one. If this still doesn't work, delete the admin collection in the database and start again",console.error(b.data)})}}]).filter("niceDate",function(){return function(a){var b={year:"numeric",month:"long",day:"numeric"};return new Date(a).toLocaleDateString("en-GB",b)}}).filter("trustHTML",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]).service("blogService",["$http","$showdown",function(a,b){return{get:function(b,c){const d=this;var e;e=b?"post/"+b:"latest/5",a.get("/api/"+e).then(function(a){if(204===a.status){console.warn("no posts yet!");const b=[{title:"Welcome",content:'This is your blog. Make a <a href="/#!/new">post</a>. ',date:new Date}];c(null,b)}else d.convertMD(a.data,function(a){c(null,a)})}).catch(function(a){c(a)})},convertMD:function(a,c){a.forEach(function(a,c){a.contentHTML=b.makeHtml(a.content)}),c(a)}}}]);